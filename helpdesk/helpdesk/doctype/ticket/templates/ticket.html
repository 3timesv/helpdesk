{% extends 'templates/web.html'%}

{% block page_content %}
{% if owner == frappe.session.user %}
<main class="content pb-4">
    <div class="container p-0">
		<div class="">
			<div class="row g-0">
				<div class="col-12 col-lg-5 col-xl-3 mb-4">
                    <strong>Ticket #{{ name }}</strong>
                    {% if status == "Resolved" %}
                    <span class="ml-2 d-inline-block rounded badge badge-success">Resolved</span>
                    {% else %}
                    <span class="ml-2 d-inline-block rounded badge badge-warning align-center">Open</span>
                    {% endif %}
                    <div class="position-relative mt-5">
                        <div id="attachmentContainer">
                        </div>
                    </div>
                </div>
				<div class="chat-container col-12 col-lg-7 col-xl-9">
                    <div class="position-relative">
                        <div class="px-4 pb-3 mb-1">
                            <div>
                                Created on {{ frappe.format_date(creation) }}
                            </div>
                            <div class="font-weight-bold">
                                {{ subject }}
                            </div>
                        </div>
                        <div id="conversationContainer" class="chat-messages p-4">
						</div>
					</div>
                    {% if status != "Resolved" %}
                    <div class="flex-grow-0 py-3 px-4">
                        <div class="input-group">
                            <input id="messageInput" type="text" class="form-control" placeholder="Type your message">
                            <button id="attachButton" class="btn btn-secondary mx-2">Attach</button>
                            <button id="submitButton" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                    {% else %}
                    <div class="card border-0 d-flex flex-row justify-content-between mt-3 p-4 bg-light">
                        <span class="mt-1">This ticket has been marked as resolved</span>
                        <button id="reOpenButton" class="btn btn-sm btn-primary mx-2">REOPEN</button>
                    </div>
                    {% endif %}
				</div>
			</div>
		</div>
	</div>
</main>
{% else %}
<div class="alert alert-warning">
    <p>
        You don't have access to this ticket.
    </p>
</div>
{% endif %}

<style>
.chat-container {
    height: 550px;
}

.chat-messages {
    display: flex;
    flex-direction: column;
    height: 550px;
    overflow-y: scroll
}

.chat-message-left,
.chat-message-right {
    display: flex;
    flex-shrink: 0
}

.chat-message-left {
    margin-right: auto
}

.chat-message-right {
    flex-direction: row-reverse;
    margin-left: auto
}

</style>
<script>
    frappe.ready(function() {
        refreshConversations(true);
        refreshAttachments();
        setInterval(refreshConversations, 5000, false);
        setInterval(refreshAttachments, 10000)

        $("#submit").click(function() {
            var data = $("#btn-input").val();
                //console.log(data);
                $('chat_log').append('<div class="row msg_container base_sent"><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>'+data+'</p></div></div></div><div class="row msg_container base_receive"><div class="col-md-10 col-xs-10"><div class="messages msg_receive"><p>'+data+'</p></div></div></div>');
                clearInput();
            });
            
            $("#submitButton").click(function() {
                frappe.call({
                    btn: this,
                    method: "helpdesk.helpdesk.doctype.ticket.ticket.create_communication_via_contact",
                    args: {
                        ticket: "{{ name }}",
                        message: $("#messageInput").val()
                    },
                    callback: function(r) {
                    $("#messageInput").val('')
                    refreshConversations(true);
				}
			})
        })
    })

    function refreshAttachments() {
        frappe.call({
            method: "helpdesk.helpdesk.doctype.ticket.ticket.get_all_attachments",
            args: {
                ticket: "{{ name }}",
            },
            callback: function(r) {
                let attachments = r.message;
                console.log(attachments)
                let attachmentContainer = $("#attachmentContainer");
                attachmentContainer.empty();
                if(attachments.length > 0) {
                    attachmentContainer.append(`
                        <div>
                            <span class="mb-2">Attachments</span>
                        </div>
                    `)
                    for(var i = 0; i < attachments.length; i++) {
                        attachmentContainer.append(`
                            <div class="pb-2">
                                <div class="flex-shrink-1 bg-light rounded py-2 px-3">
                                    ${attachments[i].file_name}
                                </div>
                            </div>
                        `);
                    }
                }
            }
        })
    }

    function refreshConversations(scroll) {
        frappe.call({
            method: "helpdesk.helpdesk.doctype.ticket.ticket.get_all_conversations",
            args: {
                ticket: "{{ name }}",
            },
            callback: function(r) {
                let conversations = r.message;
                let conversationContainer = $("#conversationContainer");
                conversationContainer.empty();
                for(var i = 0; i < conversations.length; i++) {
                    let is_received = conversations[i].sent_or_received == "Received";
                    conversationContainer.append(`
                        <div class="pb-4">
                            <div class="flex-shrink-1 bg-light rounded p-5 mr-3">
                                <div class="top-section d-flex justify-content-between mb-4">
                                    <strong>
                                        ${is_received ? "You" : "Agent"}
                                    </strong>
                                    <p>
                                        ${conversations[i].creation}
                                    </p>
                                </div>
                                <div class="message">
                                    <p>
                                        ${conversations[i].content}
                                    </p>
                                </div>
                            </div>
                        </div>
                    `);
                }
                if(scroll) {
                    $("#conversationContainer").stop().animate({ scrollTop: $("#conversationContainer")[0].scrollHeight}, 1000);
                }
            }
        })
    }

</script>

{% endblock %}