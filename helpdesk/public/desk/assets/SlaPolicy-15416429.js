import{_ as H,I,p as u,x as P,o as r,d as c,b as i,t as S,i as d,m as V,r as h,bA as R,s as U,h as L,c as w,w as _,F as E,e as D,v as A,au as M,k as x,y as C}from"./index-d9377e3a.js";import{L as $}from"./LoadingText-f736f9e5.js";import{D as F}from"./Dropdown-e0c50cd3.js";import{E as O}from"./ErrorMessage-e4ff6432.js";import{C as B}from"./CustomSwitch-323f8131.js";import"./use-tracked-pointer-4b3ac621.js";import"./use-resolve-button-type-390b11ae.js";import"./use-controllable-93c8440b.js";const z={name:"TimeDurationInput",props:["modelValue"],components:{Input:I},setup(){const t=u(0),s=u(0),l=u(""),e=u(!1);return{hours:t,minutes:s,timeStr:l,editing:e}},mounted(){if(this.modelValue){this.timeStr=this.convertSecondsToTimeStr(this.modelValue);let t=this.convertSecondsToHoursAndMinutes(this.modelValue);this.hours=t.hours?t.hours:0,this.minutes=t.minutes?t.minutes:0}},watch:{hours(t){this.updateModelValue()},minutes(t){this.updateModelValue()}},methods:{updateModelValue(){this.$emit("update:modelValue",this.convertTimeStToSeconds(`${this.hours?this.hours:"0"}h ${this.minutes?this.minutes:"0"}m`))},convertSecondsToTimeStr(t){let s=this.convertSecondsToHoursAndMinutes(t),l=s.hours,e=s.minutes,n=l>0?`${l}h`:"",a=e>0?`${e}m`:"";return`${n} ${a}`.trim()||"0h 0m"},convertTimeStToSeconds(t){let s=t.split(" "),l=0;return s.forEach(e=>{e.includes("h")?l+=e.replace("h","")*3600:e.includes("m")&&(l+=e.replace("m","")*60)}),l},convertSecondsToHoursAndMinutes(t){let s=Math.floor(t/3600),l=Math.floor(t%3600/60);return{hours:s,minutes:l}}}},W={key:0,class:"relative"},j={class:"absolute z-10 rounded shadow bg-white p-3 mt-2"},Z={class:"flex space-x-2"},q={class:"space-y-1"},G=i("div",null,"hours",-1),J={class:"space-y-1"},K=i("div",null,"minutes",-1);function Q(t,s,l,e,n,a){const m=h("Input"),y=R("on-outside-click");return P((r(),c("div",null,[i("div",null,[i("div",{class:"cursor-pointer w-24 text-right p-1.5 bg-gray-100 rounded",onClick:s[0]||(s[0]=()=>{e.editing=!e.editing})},S(a.convertSecondsToTimeStr(l.modelValue)),1)]),e.editing?(r(),c("div",W,[i("div",j,[i("div",Z,[i("div",q,[d(m,{class:"w-16",modelValue:e.hours,"onUpdate:modelValue":s[1]||(s[1]=v=>e.hours=v),type:"number"},null,8,["modelValue"]),G]),i("div",J,[d(m,{class:"w-16",modelValue:e.minutes,"onUpdate:modelValue":s[2]||(s[2]=v=>e.minutes=v),type:"number"},null,8,["modelValue"]),K])])])])):V("",!0)])),[[y,()=>{e.editing=!1}]])}const X=H(z,[["render",Q]]),Y={name:"SlaPolicy",props:["slaId"],components:{FeatherIcon:U,Input:I,LoadingText:$,Dropdown:F,ErrorMessage:O,TimeDurationInput:X,CustomSwitch:B},setup(){const t=u(!1),s=u(""),l=u(!1),e=u(""),n=u(""),a=u(""),m=u(""),y=u(""),v=u([]),f=u([]),k=A("ticketPriorities");return{isNew:t,slaPolicyName:s,tempSlaPolicyName:e,editingName:l,rules:v,workingHours:f,ticketPriorities:k,selectedHolidayList:n,rulesValidationError:a,workingHoursValidationError:m,holidayListValidationError:y}},mounted(){this.$event.emit("set-selected-setting","Support Policies"),this.$event.emit("show-top-panel-actions-settings","Support Policy"),this.isNew=this.$route.name==="NewSlaPolicy",this.editingName=!1,this.isNew?this.setDefaultValues():this.$resources.getSlaPolicy.fetch()},resources:{getSlaPolicy(){return{url:"frappe.client.get",params:{doctype:"HD Service Level Agreement",name:this.slaId,fields:["*"]},onSuccess:t=>{this.slaPolicyName=t.name,this.selectedHolidayList=t.holiday_list,this.rules=t.priorities.map(e=>({priority:e.priority,default:e.default_priority,firstResponseTime:e.response_time,resolutionTime:e.resolution_time}));let s=e=>{let n=e.split(":"),a="";return n.forEach((m,y)=>{a+=m.length==2?m:"0".concat(m),y<n.length-1&&(a+=":")}),a};this.workingHours=t.support_and_resolution.map(e=>({workday:e.workday,enabled:!0,from:s(e.start_time),to:s(e.end_time)}));let l=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"];l.forEach(e=>{this.workingHours.find(n=>n.workday==e)||this.workingHours.push({workday:e,enabled:!1,from:"00:00:00",to:"00:00:00"})}),this.workingHours=this.workingHours.sort((e,n)=>l.findIndex(a=>a==e.workday)-l.findIndex(a=>a==n.workday))}}},updateServicePolicy(){return{url:"frappe.client.set_value"}},createNewServicePolicy(){return{url:"frappe.client.insert",onSuccess:()=>{this.$router.push({name:"SlaPolicies"})}}},renameServicePolicy(){return{url:"frappe.client.rename_doc"}},getServiceHolidayList(){return{url:"frappedesk.extends.client.get_list",params:{doctype:"HD Service Holiday List",fields:["*"]},auto:!0,onSuccess:t=>{t.length>0&&(this.selectedHolidayList=t[0].holiday_list_name)}}}},computed:{priorities(){return this.rules.map(t=>({priority:t.priority,default_priority:t.default,response_time:t.firstResponseTime,resolution_time:t.resolutionTime}))},supportAndResolution(){return this.workingHours.map(t=>{if(t.enabled)return{workday:t.workday,start_time:t.from,end_time:t.to}}).filter(t=>t)},serviceHolidayList(){return this.$resources.getServiceHolidayList.data||null}},methods:{setDefaultValues(){this.slaPolicyName="New Service Policy",this.tempSlaPolicyName=this.slaPolicyName,this.rules=[{priority:"Urgent",default:!1,firstResponseTime:30*60,resolutionTime:2*3600},{priority:"High",default:!1,firstResponseTime:1*3600,resolutionTime:4*3600},{priority:"Medium",default:!0,firstResponseTime:8*3600,resolutionTime:24*3600},{priority:"Low",default:!1,firstResponseTime:24*3600,resolutionTime:72*3600}],this.workingHours=[{workday:"Monday",enabled:!0,from:"09:00",to:"17:00"},{workday:"Tuesday",enabled:!0,from:"09:00",to:"17:00"},{workday:"Wednesday",enabled:!0,from:"09:00",to:"17:00"},{workday:"Thursday",enabled:!0,from:"09:00",to:"17:00"},{workday:"Friday",enabled:!0,from:"09:00",to:"17:00"},{workday:"Saturday",enabled:!1,from:"09:00",to:"17:00"},{workday:"Sunday",enabled:!1,from:"09:00",to:"17:00"}]},editPolicyName(){this.slaPolicyName!="Default"&&(this.tempSlaPolicyName=this.slaPolicyName,this.editingName=!0)},changeDefaultPriority(t){this.rules.forEach((s,l)=>{l==t?s.default=!0:s.default=!1})},rename(){},create(){this.validateInputs()&&this.$resources.createNewServicePolicy.submit({doc:{doctype:"HD Service Level Agreement",service_level:this.tempSlaPolicyName,priorities:this.priorities,support_and_resolution:this.supportAndResolution,document_type:"HD Ticket",holiday_list:this.selectedHolidayList,sla_fulfilled_on:[{status:"Resolved"},{status:"Closed"}],pause_sla_on:[{status:"Replied"}],enabled:!0}})},save(){this.validateInputs()&&this.$resources.updateServicePolicy.submit({doctype:"HD Service Level Agreement",name:this.slaPolicyName,fieldname:{priorities:this.priorities,support_and_resolution:this.supportAndResolution}}).then(()=>{this.slaPolicyName!=this.tempSlaPolicyName&&this.rename(),this.$toast({title:"Policy updated",icon:"check",iconClasses:"text-green-500"})})},validateInputs(){this.rulesValidationError="",this.workingHoursValidationError="",this.holidayListValidationError="";let t=[];this.selectedHolidayList||(this.holidayListValidationError="A holiday list should be selected",t.push(this.holidayListValidationError));let s=!1;this.supportAndResolution.forEach(n=>{n.start_time>n.end_time&&(s=!0)}),s&&(this.workingHoursValidationError="Start time should not be after end time",t.push(this.workingHoursValidationError));let l=!1,e=!1;return this.priorities.forEach(n=>{n.default_priority&&(l=!0),(n.resolution_time==0||n.response_time==0)&&(e=!0)}),l||(this.rulesValidationError="Default rule needs to be selected",t.push(this.rulesValidationError)),e&&(this.rulesValidationError="Response and resolution time should not be 0",t.push(this.rulesValidationError)),t.length==0},cancel(){this.$router.go()},prioritiesAsDropdownOptions(t){let s=[];return this.ticketPriorities?(this.ticketPriorities.forEach(l=>{s.push({label:l.name,handler:()=>{this.rules[t].priority=l.name}})}),s):null},serviceHolidayListDropdownOptions(){let t=[];return this.serviceHolidayList?(this.serviceHolidayList.forEach(s=>{t.push({label:s.name,handler:()=>{this.selectedHolidayList=s.name}})}),t):null}}},ee={class:"p-5 overflow-auto h-full"},te={key:0},se={key:1},ie={class:"flow-root mb-4"},oe={class:"float-left"},le={key:0},ae={class:"font-semibold"},re={key:1,class:"flex space-x-2 items-center"},ne={key:1},de={class:"float-right"},ce={class:"flex space-x-2 items-center"},ue={class:"mb-5"},me=i("div",{class:"flex space-x-2 items-center"},[i("div",{class:"text-base font-semibold"},"Rules")],-1),pe={class:"text-base"},he=M('<div class="flex text-gray-600 py-4 border-b"><div class="w-2/12">Priority</div><div class="w-1/12">Default</div><div class="w-3/12 text-right"> First Response Time </div><div class="w-3/12 text-right">Resolution Time</div></div>',1),ye={class:"w-2/12"},fe={class:"flex items-center space-x-2"},_e={class:"text-left"},ve={class:"w-1/12"},ge={class:"w-3/12 flex flex-row-reverse"},we={class:"w-3/12 flex flex-row-reverse"},Se=i("div",{class:"flex space-x-2 items-center mb-3"},[i("div",{class:"text-base font-semibold"},"Working Hours")],-1),xe=i("p",{class:"text-base text-gray-700"}," Choose the days in a week, and start and end times to set as working hours. ",-1),Ve={class:"py-4 space-y-3 text-gray-900"},ke={class:"flex text-base items-center h-7"},be={class:"w-2/12"},Pe={class:"w-2/12 flex space-x-2 items-center"},Te={class:"sr-only"},Ne={key:0,class:"w-6/12 flex space-x-4 items-center"},Le=["onUpdate:modelValue"],Ee=i("div",{class:"text-gray-600"},"TO",-1),De=["onUpdate:modelValue"],Ce={class:"space-y-4"},He={class:"flex items-center space-x-2"},Ie=i("span",{class:"block mb-2 text-sm leading-4 text-gray-700"},"Holidays on",-1),Re={class:"px-3 w-52 placeholder-gray-500 block form-input"},Ue={class:"mt-5 flow-root"},Ae={class:"float-left"},Me={class:"float-right"};function $e(t,s,l,e,n,a){const m=h("LoadingText"),y=h("FeatherIcon"),v=h("Input"),f=h("Button"),k=h("Dropdown"),T=h("CustomSwitch"),N=h("TimeDurationInput"),b=h("ErrorMessage");return r(),c("div",ee,[!e.isNew&&(t.$resources.getSlaPolicy.loading||t.$resources.updateServicePolicy.loading)?(r(),c("div",te,[d(m,{text:"Fetching policy..."})])):(r(),c("div",se,[i("div",ie,[i("div",oe,[t.$resources.renameServicePolicy.loading?(r(),c("div",ne,[d(m,{text:"Renaming..."})])):(r(),c("div",le,[e.editingName?(r(),c("div",re,[d(v,{modelValue:e.tempSlaPolicyName,"onUpdate:modelValue":s[1]||(s[1]=o=>e.tempSlaPolicyName=o),type:"text",placeholder:"Enter Policy Name"},null,8,["modelValue"]),d(y,{class:"w-4 h-4 cursor-pointer",name:"x",onClick:s[2]||(s[2]=()=>{e.editingName=!1,e.tempSlaPolicyName=e.slaPolicyName})})])):(r(),c("div",{key:0,class:L(["flex space-x-2 items-center",e.slaPolicyName!="Default"?"cursor-pointer":""]),onClick:s[0]||(s[0]=o=>a.editPolicyName())},[i("div",ae,S(e.slaPolicyName),1),e.slaPolicyName!="Default"?(r(),w(y,{key:0,class:"w-3 h-3",name:"edit"})):V("",!0)],2))]))]),i("div",de,[i("div",ce,[d(f,{appearance:"secondary",onClick:s[3]||(s[3]=o=>a.cancel())},{default:_(()=>[x("Cancel")]),_:1}),e.isNew?(r(),w(f,{key:0,loading:this.$resources.createNewServicePolicy.loading,appearance:"primary",onClick:s[4]||(s[4]=o=>a.create())},{default:_(()=>[x("Create")]),_:1},8,["loading"])):(r(),w(f,{key:1,loading:this.$resources.updateServicePolicy.loading,appearance:"primary",onClick:s[5]||(s[5]=o=>a.save())},{default:_(()=>[x("Save")]),_:1},8,["loading"]))])])]),i("div",ue,[me,i("div",null,[i("div",pe,[he,(r(!0),c(E,null,D(e.rules,(o,p)=>(r(),c("div",{key:o.priority},[i("div",{class:L(["flex text-gray-900 py-2 items-center",p<e.rules.length-1?"border-b":""])},[i("div",ye,[e.ticketPriorities?(r(),w(k,{key:0,options:a.prioritiesAsDropdownOptions(p),class:"text-base w-full cursor-pointer"},{default:_(({togglePriority:g})=>[i("div",fe,[i("div",_e,S(o.priority),1)])]),_:2},1032,["options"])):V("",!0)]),i("div",ve,[d(T,{modelValue:o.default,"onUpdate:modelValue":g=>o.default=g,onClick:g=>a.changeDefaultPriority(p)},null,8,["modelValue","onUpdate:modelValue","onClick"])]),i("div",ge,[d(N,{modelValue:o.firstResponseTime,"onUpdate:modelValue":g=>o.firstResponseTime=g},null,8,["modelValue","onUpdate:modelValue"])]),i("div",we,[d(N,{modelValue:o.resolutionTime,"onUpdate:modelValue":g=>o.resolutionTime=g},null,8,["modelValue","onUpdate:modelValue"])])],2)]))),128))])]),d(b,{message:e.rulesValidationError},null,8,["message"])]),i("div",null,[Se,i("div",null,[xe,i("div",Ve,[(r(!0),c(E,null,D(e.workingHours,o=>(r(),c("div",{key:o.workday},[i("div",ke,[i("div",be,S(o.workday),1),i("div",Pe,[d(T,{modelValue:o.enabled,"onUpdate:modelValue":p=>o.enabled=p},null,8,["modelValue","onUpdate:modelValue"]),i("span",Te,S(`${o.enabled?"Open":"Closed"}`),1),i("div",null,S(o.enabled?"Open":"Closed"),1)]),o.enabled?(r(),c("div",Ne,[P(i("input",{class:"rounded py-1 bg-gray-100 border-0 text-base w-[6.4rem] px-1",type:"time","onUpdate:modelValue":p=>o.from=p},null,8,Le),[[C,o.from]]),Ee,P(i("input",{class:"rounded py-1 bg-gray-100 border-0 text-base w-[6.4rem] px-1",type:"time","onUpdate:modelValue":p=>o.to=p},null,8,De),[[C,o.to]])])):V("",!0)])]))),128)),d(b,{message:e.workingHoursValidationError},null,8,["message"])]),i("div",Ce,[a.serviceHolidayList?(r(),w(k,{key:0,options:a.serviceHolidayListDropdownOptions(),class:"text-base w-53 cursor-pointer",placement:"left"},{default:_(({toggleHolidayList:o})=>[i("div",He,[i("div",null,[Ie,i("div",Re,S(e.selectedHolidayList),1)])])]),_:1},8,["options"])):V("",!0),d(b,{message:e.holidayListValidationError},null,8,["message"])])]),i("div",Ue,[i("div",Ae,[d(f,{appearance:"secondary",onClick:s[6]||(s[6]=o=>a.cancel())},{default:_(()=>[x("Cancel")]),_:1})]),i("div",Me,[e.isNew?(r(),w(f,{key:0,loading:this.$resources.createNewServicePolicy.loading,appearance:"primary",onClick:s[7]||(s[7]=o=>a.create())},{default:_(()=>[x("Create")]),_:1},8,["loading"])):(r(),w(f,{key:1,loading:this.$resources.updateServicePolicy.loading,appearance:"primary",onClick:s[8]||(s[8]=o=>a.save())},{default:_(()=>[x("Save")]),_:1},8,["loading"]))])])])]))])}const Ge=H(Y,[["render",$e]]);export{Ge as default};
