import{_ as w,s as V,o as l,d,c as g,w as p,b as i,t as x,i as n,m as f,v,r as c,ca as C,h as y,u as B,F as j,e as R,p as _,G as L,k as S,H as I}from"./index-d9377e3a.js";import{D as O}from"./Dropdown-e0c50cd3.js";import{E as q,S as U}from"./SearchSection-0e11276b.js";import{B as K}from"./Breadcrumbs-4289cef3.js";import{E as M}from"./ErrorMessage-e4ff6432.js";import{A as z}from"./Autocomplete-c752a27e.js";import{C as G}from"./CategorySelector-c2fcec0b.js";import{T as J,a as Q}from"./TextEditor-b1ee2b34.js";import{B as W}from"./BaseBreadcrumbs-472c50b6.js";import"./use-tracked-pointer-4b3ac621.js";import"./use-resolve-button-type-390b11ae.js";import"./LoadingText-f736f9e5.js";import"./CustomIcons-60888788.js";import"./use-controllable-93c8440b.js";const X={name:"ArticleDetails",props:{article:{type:Object,default:null},articleResource:{type:Object,default:null},isNew:{type:Boolean,default:!1}},components:{FeatherIcon:V,ErrorMessage:M,Autocomplete:z,CategorySelector:G},setup(){const e=v("updateArticleTempValues"),s=v("articleTempValues"),r=v("articleInputErrors");return{updateArticleTempValues:e,articleTempValues:s,articleInputErrors:r}},resources:{users(){return{url:"frappedesk.extends.client.get_list",params:{doctype:"User",fields:["name","full_name"],filters:{enabled:1},limit:9999},auto:!0}}},methods:{setArticleDetail(e,s){if(this.isNew)this.updateArticleTempValues({field:e,value:s});else{let r={};r[e]=s,this.articleResource.setValue.submit(r).then(()=>{e==="category"&&this.$router.go()})}}}},Y={class:"flex flex-col rounded shadow p-5 text-base space-y-[12px]"},Z=i("div",{class:"font-semibold"},"Details",-1),$=i("div",{class:"border-b w-full"},null,-1),ee={key:1,class:"flex flex-col"},te=i("span",{class:"block mb-2 text-sm leading-4 text-gray-700"}," Author ",-1),re={key:2,class:"flex flex-row items-center text-[12px] text-gray-700"},se={class:"flex flex-row items-center space-x-[6px]"},ae={class:"w-[28px] text-left"},ie={class:"flex flex-row items-center space-x-[6px]"},le={class:"w-[28px] text-left"},oe={class:"flex flex-row items-center space-x-[6px]"},ce={class:"w-[28px] text-left"};function ne(e,s,r,t,k,a){const o=c("FeatherIcon"),u=c("router-link"),h=c("Autocomplete"),b=c("ErrorMessage"),A=c("CategorySelector");return l(),d("div",Y,[Z,$,r.article.published_on?(l(),g(u,{key:0,to:`/support/kb/articles/${r.article.name}`,target:"_blank",class:"flex flex-row justify-between items-center"},{default:p(()=>[i("div",null," Published "+x(e.$dayjs.shortFormating(e.$dayjs(r.article.published_on).fromNow(),!0)),1),n(o,{name:"external-link",class:"w-4"})]),_:1},8,["to"])):f("",!0),e.$resources.users.data?(l(),d("div",ee,[te,n(h,{options:e.$resources.users.data.map(m=>({label:m.name,value:m.name})),placeholder:"Choose author",value:r.isNew?t.articleTempValues?.author:r.article.author,onChange:s[0]||(s[0]=m=>{m&&a.setArticleDetail("author",m.value)})},null,8,["options","value"]),n(b,{message:t.articleInputErrors.author},null,8,["message"])])):f("",!0),i("div",null,[n(A,{selectedCategory:r.isNew?t.articleTempValues?.category:r.article.category,onSelection:s[1]||(s[1]=m=>{a.setArticleDetail("category",m.name)})},null,8,["selectedCategory"]),n(b,{message:t.articleInputErrors.category},null,8,["message"])]),r.isNew?f("",!0):(l(),d("div",re,[i("div",se,[n(o,{name:"eye",class:"w-[16px] stroke-gray-500"}),i("div",ae,x(r.article.views||0),1)]),i("div",ie,[n(o,{name:"smile",class:"w-[14px] stroke-gray-500"}),i("div",le,x(r.article.helpful||0),1)]),i("div",oe,[n(o,{name:"frown",class:"w-[14px] stroke-gray-500"}),i("div",ce,x(r.article.not_helpful||0),1)])]))])}const de=w(X,[["render",ne]]),ue={name:"ArticleTitleAndContent",props:["article","editable","editMode"],components:{ErrorMessage:M,TextEditor:J,TextEditorFixedMenu:Q},setup(){const e=v("updateArticleTempValues");return{articleInputErrors:v("articleInputErrors"),updateArticleTempValues:e}},watch:{editMode(e){e||this.$refs.textEditor.editor.commands.setContent(this.article.content)}},computed:{textEditorMenuButtons(){return["Paragraph",["Heading 2","Heading 3","Heading 4","Heading 5","Heading 6"],"Separator","Bold","Italic","Separator","Bullet List","Numbered List","Separator","Align Left","Align Center","Align Right","Separator","Image","Video","Link","Blockquote","Code","Horizontal Rule",["InsertTable","AddColumnBefore","AddColumnAfter","DeleteColumn","AddRowBefore","AddRowAfter","DeleteRow","MergeCells","SplitCell","ToggleHeaderColumn","ToggleHeaderRow","ToggleHeaderCell","DeleteTable"],"Separator","Undo","Redo"]}},methods:{onTitleInput:C(function(e){this.updateArticleTempValues({field:"title",value:e})},300),onContentInput:C(function(e){this.updateArticleTempValues({field:"content",value:e})},300)}},he={class:"flex h-full flex-col space-y-[16px]"},me={key:0,class:"flex flex-col"},pe={key:1,class:"text-[24px] font-semibold"},fe={class:"flex flex-col"},be={key:0,class:"mb-2 block text-sm leading-4 text-gray-700"},_e={key:0};function ge(e,s,r,t,k,a){const o=c("Input"),u=c("ErrorMessage"),h=c("TextEditorFixedMenu"),b=c("TextEditor");return l(),d("div",he,[i("div",null,[r.editMode?(l(),d("div",me,[n(o,{label:"Title",type:"text",value:r.article.title,onInput:a.onTitleInput},null,8,["value","onInput"]),n(u,{message:t.articleInputErrors.title},null,8,["message"])])):(l(),d("div",pe,x(r.article.title),1))]),i("div",null,[i("div",fe,[r.editMode?(l(),d("div",be," Content ")):f("",!0),n(b,{class:y(r.editMode?"bg-gray-100":""),ref:"textEditor","editor-class":r.editable?r.editMode?"min-h-[20rem] overflow-y-auto max-h-[73vh] w-full px-3":"min-h-[20rem] overflow-y-auto max-h-[85vh]":"flex flex-col",content:r.article.content,"starterkit-options":{heading:{levels:[2,3,4,5,6]}},onChange:a.onContentInput,editable:r.editMode},{top:p(()=>[r.editMode?(l(),d("div",_e,[n(h,{class:"m-3 overflow-x-auto",buttons:a.textEditorMenuButtons},null,8,["buttons"])])):f("",!0)]),_:1},8,["class","editor-class","content","onChange","editable"]),n(u,{message:t.articleInputErrors.content},null,8,["message"])])])])}const xe=w(ue,[["render",ge]]),ke={name:"ArticleFeedback",props:{article:{type:Object,default:null}},setup(){return{authStore:B()}},data(){return{refreshKey:0}},computed:{feedback(){if(this.refreshKey,this.authStore.isLoggedIn){const e=this.$resources.articleFeedback.data||[];return e.length>0?e[0].feedback:null}else return JSON.parse(localStorage.getItem(`article-${this.article.name}-feedback`))},feedbackOptions(){return[{score:0,emoji:"ðŸ˜ž"},{score:1,emoji:"ðŸ˜ƒ"}]}},resources:{articleFeedback(){if(this.authStore.isLoggedIn)return{url:"frappedesk.extends.client.get_list",params:{doctype:"User Article Feedback",filters:{article:this.article.name,user:this.authStore.userId},fields:["*"]},auto:!0}},submitArticleFeedback(){return{url:"frappedesk.api.kb.submit_article_feedback",onSuccess:e=>{}}}},methods:{async submitFeedback(e){return this.authStore.isLoggedIn||localStorage.setItem(`article-${this.article.name}-feedback`,e),await this.$resources.submitArticleFeedback.submit({article:this.article.name,score:e,previous_score:this.feedback}).then(()=>{this.authStore.isLoggedIn?this.$resources.articleFeedback.fetch():this.refreshKey+=1})}}},ve={class:"py-3 px-20 border-t pt-5 mt-5"},ye={class:"flex flex-col space-y-2 items-center text-base text-gray-700"},we=i("div",null,"Did you find this useful?",-1),Ae={class:"flex flex-row space-x-5"},Ie=["onClick"];function Ee(e,s,r,t,k,a){return l(),d("div",ve,[i("div",ye,[we,i("div",Ae,[(l(!0),d(j,null,R(a.feedbackOptions,o=>(l(),d("div",{key:o},[i("div",{onClick:()=>{a.submitFeedback(o.score).then(()=>{e.$toast({title:"Thanks for your feedback!",customIcon:"circle-check",appearance:"success"})})},class:y(["hover:text-5xl cursor-pointer text-5xl hover:saturate-100",a.feedback!==null?a.feedback===o.score?"":"saturate-0":"saturated-100"]),style:{color:"#855223"}},x(o.emoji),11,Ie)]))),128))])])])}const Te=w(ke,[["render",Ee]]),Ce={name:"Article",components:{EditableBlock:q,SearchSection:U,Breadcrumbs:K,ArticleDetails:de,ArticleTitleAndContent:xe,Dropdown:O,FeatherIcon:V,BaseBreadcrumbs:W,ArticleFeedback:Te},props:{articleId:{type:String,default:null}},setup(){const e=B(),s=L(),r=_(s.meta.editable),t=_(s.meta.isNew||!1),k=_(s.meta.editMode||!1),a=_(!1),o=_({});t.value&&(o.value={author:e.userId,category:s.meta.category||null});const u=_(()=>{}),h=_({}),b=_({});return I("updateArticleTempValues",u),I("articleTempValues",o),I("articleInputErrors",h),{editable:r,isNew:t,editMode:k,saveInProgress:a,articleTempValues:o,updateArticleTempValues:u,articleInputErrors:h,validators:b}},computed:{disableSaving(){return!1},article(){return this.isNew?{}:this.editable?this.$resources.article.doc||{}:this.$resources.article.data||{}}},mounted(){this.validators={title:this.validateTitle,content:this.validateContent,author:this.validateAuthor,category:this.validateCategory},this.updateArticleTempValues=e=>{this.articleTempValues[e.field]=e.value,this.validators[e.field](e.value)},this.editable||this.$resources.incrementArtileViews.submit({article:this.articleId})},resources:{incrementArtileViews:{url:"frappedesk.api.kb.increment_article_views"},article(){return this.isNew?{}:this.editable?{type:"document",doctype:"HD Article",name:this.articleId,setValue:{onSuccess:()=>{this.$toast({title:"Article updated",icon:"check",iconClasses:"text-green-500"})},onError:e=>{this.$toast({title:"Error while updating article",text:e,icon:"x",iconClasses:"text-red-500"})}}}:{url:"frappedesk.api.kb.get_article",params:{article:this.articleId},auto:!0}},newArticle(){return{url:"frappe.client.insert",onSuccess:e=>{this.$router.push(`/frappedesk/kb/articles/${e.name}`)},onError:e=>{this.$toast({title:"Error while creating article",text:e,icon:"x",iconClasses:"text-red-500"})}}},checkIfTitleExists(){return{url:"frappedesk.api.kb.check_if_article_title_exists",onSuccess:e=>{e?this.articleInputErrors.title="Article with this title already exists":this.articleInputErrors.title=""}}}},methods:{async validateTitle(e){return this.articleInputErrors.titlle="",!e||e==""?this.articleInputErrors.title="Title is required":e.length<=3?this.articleInputErrors.title="Title should be atleast 3 characters long":await this.$resources.checkIfTitleExists.submit({title:e,name:this.isNew?null:this.article.name}),this.articleInputErrors.title},validateContent(e){return this.articleInputErrors.content="",(!e||e.replaceAll(" ","")=="<p></p>")&&(this.articleInputErrors.content="Content is required"),this.articleInputErrors.content},validateAuthor(e){return this.articleInputErrors.author="",e||(this.articleInputErrors.author="Author is required"),this.articleInputErrors.author},validateCategory(e){return this.articleInputErrors.category="",e||(this.articleInputErrors.category="Category is required"),this.articleInputErrors.category},async validateChanges(){const e=this.articleTempValues;let s="";return s+=await this.validateTitle(e.title),s+=this.validateContent(e.content),s+=this.validateAuthor(e.author),s+=this.validateCategory(e.category),s.length==0},async saveChanges(e=!1){if(await this.validateChanges()){if(this.saveInProgress=!0,this.isNew)this.articleTempValues.status=e?"Published":"Draft",await this.$resources.newArticle.submit({doc:{doctype:"HD Article",...this.articleTempValues}});else{let s=this.articleTempValues.title!=this.article.title;await this.$resources.article.setValue.submit({title:this.articleTempValues.title,content:this.articleTempValues.content,status:e?"Published":"Draft"}),s&&this.$router.go()}this.editMode=!1,this.saveInProgress=!1}}}},Se={class:"grid h-full grid-cols-1"},Ve={class:"flex grow flex-row space-x-[24px]"},Be={class:"w-[250px] shrink-0"};function Me(e,s,r,t,k,a){const o=c("Breadcrumbs"),u=c("BaseBreadcrumbs"),h=c("Button"),b=c("Dropdown"),A=c("SearchSection"),m=c("ArticleTitleAndContent"),D=c("ArticleDetails"),F=c("ArticleFeedback"),N=c("EditableBlock");return l(),g(N,{class:"h-full",editable:t.editable,"edit-mode":t.editMode,"save-in-progress":t.saveInProgress,"disable-saving":a.disableSaving,onEdit:s[1]||(s[1]=()=>{t.editMode=!0,t.articleTempValues={...a.article}}),onDiscard:s[2]||(s[2]=()=>{t.isNew?e.$router.push({path:"/frappedesk/kb/articles"}):t.editMode=!1}),onSave:a.saveChanges},{"top-left-section":p(()=>[i("div",null,[t.isNew?(l(),g(u,{key:1,breadcrumbs:[{label:"Articles",name:"articles",handler:()=>{e.$router.push({path:`/${t.editable?"frappedesk":"support"}/kb/articles`})}},{label:"New",name:"new"}]},null,8,["breadcrumbs"])):(l(),g(o,{key:0,"doc-type":"HD Article","doc-name":r.articleId,"is-desk":t.editable},null,8,["doc-name","is-desk"]))])]),"other-main-actions":p(()=>[i("div",null,[n(h,{loading:t.saveInProgress,appearance:a.article.status==="Published"?"secondary":"primary",onClick:s[0]||(s[0]=()=>{t.articleTempValues={...a.article},a.saveChanges(a.article.status!=="Published")})},{default:p(()=>[S(x(a.article.status==="Published"?"Unpublish":"Publish"),1)]),_:1},8,["loading","appearance"])])]),"save-action":p(({save:E,disableSaving:T,saveInProgress:P})=>[n(b,{placement:"right",options:[{label:"Save",handler:()=>{E()}},{label:"Save and Publish",handler:()=>{E(!0)}}]},{default:p(({toggleDropdown:H})=>[n(h,{loading:P,"icon-right":"chevron-down",class:y(["ml-2",T?"cursor-not-allowed":""]),disable:T,onClick:H},{default:p(()=>[S(" Save ")]),_:2},1032,["loading","class","disable","onClick"])]),_:2},1032,["options"])]),body:p(()=>[i("div",Se,[t.editable?f("",!0):(l(),g(A,{key:0,disabled:t.editable,class:"mb-5"},null,8,["disabled"])),i("div",{class:y(["flex h-full flex-col",t.editable?"":"container mx-auto"])},[t.editable?f("",!0):(l(),g(o,{key:0,"doc-type":"HD Article","doc-name":r.articleId,"is-desk":t.editable,class:"mb-5"},null,8,["doc-name","is-desk"])),i("div",Ve,[n(m,{class:"grow",editable:t.editable,"edit-mode":t.editMode,article:a.article},null,8,["editable","edit-mode","article"]),i("div",Be,[t.editable?(l(),g(D,{key:0,article:a.article,"article-resource":e.$resources.article,"is-new":t.isNew},null,8,["article","article-resource","is-new"])):f("",!0)])]),t.editable?f("",!0):(l(),g(F,{key:1,article:a.article},null,8,["article"]))],2)])]),_:1},8,["editable","edit-mode","save-in-progress","disable-saving","onSave"])}const Je=w(Ce,[["render",Me]]);export{Je as default};
