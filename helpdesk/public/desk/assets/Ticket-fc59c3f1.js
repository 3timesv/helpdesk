import{_ as I,s as S,av as U,r as m,o as n,d as r,i,b as s,t as x,h as T,F as C,e as y,m as h,p as _,u as H,w as f,c as k,f as V,v as P,k as g}from"./index-d9377e3a.js";import{A as E}from"./Avatar-166461f8.js";import{F as z}from"./FileUploader-997fc331.js";import{T as K,a as O}from"./TextEditor-b1ee2b34.js";import{L as W}from"./LoadingText-f736f9e5.js";import{C as q}from"./CustomIcons-60888788.js";import{C as G,T as J}from"./CustomerSatisfactionFeedback-1d6ae62c.js";import"./Autocomplete-c752a27e.js";import"./use-tracked-pointer-4b3ac621.js";import"./use-resolve-button-type-390b11ae.js";import"./use-controllable-93c8440b.js";const Q={name:"ConversationCard",props:["userName","profilePicUrl","time","message","color","attachments"],components:{Avatar:E,FeatherIcon:S},computed:{cleanedMessage(){return this.message?U(this.message):""}}},X={class:"flex mt-5"},Y={class:"w-full ml-2 pt-1"},Z={class:"flex justify-between"},$={class:"text-lg"},ee={class:"text-sm text-slate-500"},te=["innerHTML"],se={key:0,class:"flex space-x-2 flex-wrap mt-3"},oe=["href"];function ne(e,t,d,l,u,o){const p=m("Avatar"),v=m("FeatherIcon");return n(),r("div",X,[i(p,{label:d.userName,imageURL:d.profilePicUrl,size:"md"},null,8,["label","imageURL"]),s("div",Y,[s("div",Z,[s("div",$,x(d.userName),1),s("div",ee,x(e.$dayjs.longFormating(e.$dayjs(d.time).fromNow())),1)]),s("div",{class:T(["grow rounded p-2 text-base mt-2",`bg-${d.color}-50`])},[s("div",{class:"message text-[13px]",style:{border:"0px"},innerHTML:o.cleanedMessage},null,8,te),d.attachments.length>0?(n(),r("div",se,[(n(!0),r(C,null,y(d.attachments,c=>(n(),r("div",{key:c},[s("a",{href:c.file_url,target:"_blank",class:"py-1 rounded-sm text-gray-900 hover:underline flex items-center space-x-1"},[i(v,{name:"paperclip",class:"h-[12px] w-[12px]"}),s("span",null,x(c.file_name),1)],8,oe)]))),128))])):h("",!0)],2)])])}const re=I(Q,[["render",ne],["__scopeId","data-v-4263722b"]]),ie={name:"Conversations",props:["ticketId","scrollToBottom"],components:{ConversationCard:re,LoadingText:W},setup(){const e=_({}),t=_(-1);return{userColors:e,lastColorIndex:t}},resources:{conversations(){return{url:"frappedesk.api.ticket.get_conversations",params:{ticket_id:this.ticketId},auto:!0}}},computed:{conversations(){return this.$nextTick(()=>{this.autoScrollToBottom()}),this.$resources.conversations.data||null}},watch:{scrollToBottom(e){e&&this.autoScrollToBottom()}},mounted(){this.$socket.on("list_update",e=>{e.doctype=="Ticket"&&e.name==this.ticketId&&this.$resources.conversations.fetch()})},unmounted(){this.$socket.off("list_update")},methods:{getUserName(e){return(e.sender.first_name?e.sender.first_name:"")+" "+(e.sender.last_name?e.sender.last_name:"")},autoScrollToBottom(){if(this.conversations){const[e]=this.$refs["conversation-"+(this.conversations.length-1)];e&&e.scrollIntoView({behavior:"smooth"})}},getConversationCardColor(e){const t=this.getUserName(e);let d=["blue","gray","green","red"];return this.userColors[t]||(this.lastColorIndex==d.length-1?this.lastColorIndex=0:this.lastColorIndex++,this.userColors[t]=d[this.lastColorIndex]),this.userColors[t]}}},ae={key:0},le={key:1,class:"p-5"};function ce(e,t,d,l,u,o){const p=m("ConversationCard"),v=m("LoadingText");return n(),r("div",null,[o.conversations?(n(),r("div",ae,[(n(!0),r(C,null,y(o.conversations,(c,b)=>(n(),r("div",{key:c.name,class:"flex flex-col",ref_for:!0,ref:"conversationContainer"},[s("div",{ref_for:!0,ref:`conversation-${b}`},[i(p,{userName:o.getUserName(c),profilePicUrl:c.sender.image?c.sender.image:"",time:c.creation,message:c.content,attachments:c.attachments,color:o.getConversationCardColor(c)},null,8,["userName","profilePicUrl","time","message","attachments","color"])],512)]))),128))])):(n(),r("div",le,[i(v,{text:"Fetching conversations..."})]))])}const de=I(ie,[["render",ce]]),me={name:"Tickets",props:["ticketId"],components:{Conversations:de,FeatherIcon:S,TextEditor:K,TextEditorFixedMenu:O,FileUploader:z,CustomIcons:q,CustomerSatisfactionFeedback:G,Avatar:E,TicketField:J},data(){return{editing:!1,scrollConversationsToBottom:!1,content:"",subject:""}},setup(){const e=H(),t=_(null),d=P("viewportWidth"),l=_([]),u=_({}),o=_(!0),p=_(!1);return{authStore:e,editor:t,viewportWidth:d,attachments:l,tempTextEditorData:u,showTextFormattingMenu:o,editingSubject:p}},computed:{ticket(){return this.$resources.ticket.doc||null},textEditorMenuButtons(){return["Paragraph",["Heading 2","Heading 3","Heading 4","Heading 5","Heading 6"],"Separator","Bold","Italic","Separator","Bullet List","Numbered List","Separator","Align Left","Align Center","Align Right","Separator","Image","Video","Link","Blockquote","Code","Horizontal Rule",["InsertTable","AddColumnBefore","AddColumnAfter","DeleteColumn","AddRowBefore","AddRowAfter","DeleteRow","MergeCells","SplitCell","ToggleHeaderColumn","ToggleHeaderRow","ToggleHeaderCell","DeleteTable"],"Separator","Undo","Redo"]},sendingDisabled(){let e=this.content.trim();return e=e.replaceAll("<p></p>",""),e=e.replaceAll(" ",""),(e==""||e=="<p><br></p>"||e=="<p></p>")&&this.attachments.length==0},customFields(){return this.$resources.customFields.data||null}},resources:{ticket(){return{type:"document",doctype:"HD Ticket",name:this.ticketId}},customFields(){return{url:"frappedesk.api.ticket.get_custom_fields",params:{doctype:"HD Ticket",view:"Customer Portal"},auto:!0}},submitConversation(){return{url:"frappedesk.api.ticket.submit_conversation_via_contact",onSuccess:()=>{this.tempTextEditorData={},this.editing=!1},onError:()=>{this.content=this.tempTextEditorData.content,this.attachments=this.tempTextEditorData.attachments}}}},methods:{handleShortcuts(e){(e.metaKey||e.ctrlKey)&&e.keyCode==13?this.sendingDisabled||this.submitConversation():(e.metaKey||e.ctrlKey)&&e.keyCode==75?this.$refs.replyEditor.insertLink():e.keyCode===27&&this.cancelEditing()},startEditing(){this.editing=!0,this.delayedConversationScroll(),this.$nextTick(()=>{this.$refs.replyEditor.editor.commands.focus()})},cancelEditing(){this.editing=!1},delayedConversationScroll(){function e(t){return new Promise(d=>setTimeout(d,t))}e(400).then(()=>this.scrollConversationsToBottom=!0),e(1e3).then(()=>this.scrollConversationsToBottom=!1)},submitConversation(){this.tempTextEditorData.content=this.content,this.tempTextEditorData.attachments=this.attachments;const e=`<div class='content-block'><div>${this.content}</div></div>`;this.$resources.submitConversation.submit({ticket_id:this.ticketId,message:e,attachments:this.attachments.map(t=>t.name)}),this.attachments=[],this.content=""}}},ue={class:"flex justify-between mb-4"},he={class:"flex items-center space-x-2 text-lg"},pe=s("a",{href:"/support/kb"},"Home",-1),fe={class:"text-gray-400"},_e={key:0,class:"flex items-center pb-2 justify-between"},xe={class:"text-5xl font-bold"},ge={key:1,class:"flex gap-2 items-center pb-2 justify-between"},ve={class:"flex flex-row gap-2"},ke={class:"flex flex-row h-full"},Ce={class:"grow flex flex-col h-full space-y-2"},ye={class:"overflow-auto grow"},be={key:0,class:"w-full bg-gray-100 rounded-[8px] py-[10px] px-[15px] flex flex-row items-center justify-between mb-[12px]"},we={class:"flex flex-row items-center space-x-[9px]"},Te=s("div",{class:"text-base"}," This ticket has been closed. ",-1),Ie={key:0,class:"mt-5 ml-9"},Fe={class:"flex flex-col"},Se={class:"grow"},Ee={class:"flex"},Be={class:"w-full ml-2 pt-1"},je={class:"flex flex-col space-y-2"},Ae={key:0,class:"text-lg"},Re={key:1,class:"grow"},Le={key:0,class:"max-h-[100px] overflow-y-scroll rounded flex flex-col"},De={class:"flex flex-wrap gap-2 py-2"},Me=["title"],Ne={class:"flex flex-row items-center space-x-1"},Ue={class:"text-[12px] text-gray-700 font-normal ml-2 max-w-[100px] truncate"},He=["onClick"],Ve={key:1},Pe={key:2,class:"pt-2 select-none flex flex-row items-center space-x-2"},ze={class:"flex flex-row items-center space-x-2"},Ke={class:"grow flex flex-row-reverse"},Oe={key:0,class:"ml-5 flex flex-col space-y-[12px] w-[200px]"};function We(e,t,d,l,u,o){const p=m("FeatherIcon"),v=m("router-link"),c=m("Button"),b=m("Input"),F=m("CustomIcons"),B=m("CustomerSatisfactionFeedback"),j=m("Conversations"),A=m("Avatar"),R=m("TextEditorFixedMenu"),L=m("FileUploader"),D=m("TextEditor"),M=m("TicketField");return o.ticket?(n(),r("div",{key:0,class:T(["mx-auto mt-5 max-w-4xl",{"max-w-5xl":o.customFields?.length>0}])},[s("div",{style:V({height:l.viewportWidth>768?"calc(100vh - 14rem)":null})},[s("div",ue,[s("div",he,[pe,i(p,{name:"chevron-right",class:"h-3 w-3"}),i(v,{to:{name:"ProtalTickets"}},{default:f(()=>[g("Tickets")]),_:1}),i(p,{name:"chevron-right",class:"h-3 w-3"}),s("div",fe,x(o.ticket.name),1)]),s("div",null,[["Open","Replied"].includes(o.ticket.status)?(n(),k(c,{key:0,onClick:t[0]||(t[0]=()=>{e.$resources.ticket.setValue.submit({status:"Closed"})}),class:"bg-gray-100 text-red-500"},{default:f(()=>[g(" Close ")]),_:1})):h("",!0)])]),l.editingSubject?(n(),r("div",ge,[i(b,{class:"w-full",id:"subjectInput",value:o.ticket.subject,onChange:t[2]||(t[2]=a=>u.subject=a),type:"text"},null,8,["value"]),s("div",ve,[i(c,{appearance:"primary",onClick:t[3]||(t[3]=()=>{e.$resources.ticket.setValue.submit({subject:u.subject}).then(l.editingSubject=!1)})},{default:f(()=>[g("Save")]),_:1}),i(c,{appearance:"secondary",onClick:t[4]||(t[4]=a=>e.$router.go())},{default:f(()=>[g("Discard")]),_:1})])])):(n(),r("div",_e,[s("div",xe,x(o.ticket.subject),1),i(p,{class:"w-4 h-4 cursor-pointer",name:"edit",onClick:t[1]||(t[1]=a=>l.editingSubject=!0)})])),s("div",ke,[s("div",Ce,[s("div",ye,[["Closed","Resolved"].includes(o.ticket.status)?(n(),r("div",be,[s("div",we,[i(F,{name:"circle-check",class:"w-[18px] h-[18px]"}),Te]),s("div",{class:"text-[#096CC3] text-[12px] font-medium cursor-pointer hover:text-blue-500",onClick:t[5]||(t[5]=()=>{e.$resources.ticket.setValue.submit({status:"Open"})})}," Reopen ticket ")])):h("",!0),["Closed","Resolved"].includes(o.ticket.status)?(n(),k(B,{key:1,ticket:o.ticket},null,8,["ticket"])):h("",!0),i(j,{ticketId:o.ticket.name,scrollToBottom:u.scrollConversationsToBottom},null,8,["ticketId","scrollToBottom"])]),!u.editing&&["Open","Replied"].includes(o.ticket.status)?(n(),r("div",Ie,[i(c,{onClick:t[6]||(t[6]=a=>o.startEditing()),appearance:"primary"},{default:f(()=>[g("Reply")]),_:1})])):h("",!0),s("div",Fe,[s("div",Se,[s("div",Ee,[u.editing?(n(),k(A,{key:0,label:l.authStore.user,imageURL:l.authStore.userImage,size:"md"},null,8,["label","imageURL"])):h("",!0),s("div",Be,[s("div",je,[u.editing?(n(),r("div",Ae,x(l.authStore.doc.full_name),1)):h("",!0),["Closed","Resolved"].includes(o.ticket.status)?h("",!0):(n(),r("div",Re,[u.editing?(n(),k(D,{key:0,ref:"replyEditor",content:u.content,"editor-class":"text-[13px] min-h-[180px] max-h-[300px] max-w-full overflow-y-scroll",onKeydown:t[11]||(t[11]=a=>o.handleShortcuts(a)),onChange:t[12]||(t[12]=a=>{u.content=a}),onClick:t[13]||(t[13]=a=>e.$refs.replyEditor.editor.commands.focus()),placeholder:"Type a response",class:"border border-gray-300 rounded-[8px] p-[12px]"},{bottom:f(()=>[s("div",null,[l.attachments.length?(n(),r("div",Le,[s("ul",De,[(n(!0),r(C,null,y(l.attachments,a=>(n(),r("li",{class:"flex items-center p-1 space-x-2 bg-gray-100 border-gray-400 border shadow rounded",key:a,title:a.name},[s("div",Ne,[i(p,{name:"file-text",class:"h-[15px] stroke-gray-600"}),s("span",Ue,x(a.file_name),1)]),s("button",{class:"grid w-4 h-4 text-gray-700 rounded hover:bg-gray-300 place-items-center",onClick:()=>{l.attachments=l.attachments.filter(w=>w.name!=a.name)}},[i(p,{class:"w-3",name:"x"})],8,He)],8,Me))),128))])])):h("",!0),l.showTextFormattingMenu?(n(),r("div",Ve,[i(R,{class:"my-1 overflow-x-auto rounded shadow-sm border",buttons:o.textEditorMenuButtons},null,8,["buttons"])])):h("",!0),e.$refs.replyEditor?(n(),r("div",Pe,[i(c,{loading:e.$resources.submitConversation.loading,onClick:t[7]||(t[7]=a=>o.submitConversation()),appearance:"primary"},{default:f(()=>[g(" Send ")]),_:1},8,["loading"]),s("div",ze,[i(F,{class:T([l.showTextFormattingMenu?"bg-gray-200":"","h-7 w-7 rounded p-1"]),name:"text-formatting",role:"button",onClick:t[8]||(t[8]=()=>{l.showTextFormattingMenu=!l.showTextFormattingMenu})},null,8,["class"]),i(L,{onSuccess:t[9]||(t[9]=a=>l.attachments.push(a))},{default:f(({progress:a,uploading:w,openFileSelector:N})=>[i(p,{name:"paperclip",class:"h-[17px]",onClick:N,role:"button",disabled:w},null,8,["onClick","disabled"])]),_:1})]),s("div",Ke,[i(p,{name:"trash-2",role:"button",class:"h-4 w-4",onClick:t[10]||(t[10]=()=>{u.content="",l.attachments=[],u.editing=!1})})])])):h("",!0)])]),_:1},8,["content"])):h("",!0)]))])])])])])]),o.customFields?.length>0?(n(),r("div",Oe,[(n(!0),r(C,null,y(o.customFields,a=>(n(),r("div",{key:a.fieldname},[i(M,{ticketId:o.ticket.name,fieldname:a.fieldname,editable:a.is_editable_by_customer},null,8,["ticketId","fieldname","editable"])]))),128))])):h("",!0)])],4)],2)):h("",!0)}const ot=I(me,[["render",We]]);export{ot as default};
