import{_ as H,u as z,p as h,aq as K,M as o,ar as W,O as X,R as Y,V as Z,o as D,d as ee,a as te,ap as le,G as ae,H as se}from"./index-d9377e3a.js";const re={name:"ListManager",props:["options"],setup(n,d){const $=le(),f=ae(),m=z(),t=h({handleRowClick:()=>{},urlQueryFilters:n.options.urlQueryFilters||!1,saveFiltersLocally:n.options.saveFiltersLocally||!1,cache:n.options.cache||null,fields:[...new Set([...n.options.fields||[],"name"])],doctype:n.options.doctype,filters:n.options.filters||[],pageLength:n.options.limit||20,start:0,orderBy:n.options.order_by||""}),g=K({type:"list",url:"frappedesk.extends.client.get_list",cache:!1,doctype:t.value.doctype,fields:t.value.fields,orderBy:t.value.orderBy,filters:t.value.filters,pageLength:t.value.pageLength,start:t.value.start,realtime:!0,pageLength:3},d),N=o(()=>(O.fetch({doctype:t.value.doctype,filters:t.value.filters}),g.list.data||[])),I=o(()=>g.list.loading),O=W({url:"frappe.client.get_count"},d),_=o(()=>O.data||0),L=()=>{s.value={},g.reload()},k=()=>{g.list.fetch()},p=(e=null)=>{e&&(e.filters&&(t.value.filters=e.filters),e.orderBy&&(t.value.orderBy=e.orderBy)),g.update({...t.value})},Q=e=>{e<0||e>b.value||(t.value.start=(e-1)*t.value.pageLength,p(),k())},A=()=>{F.value!=b.value&&(t.value.start+=t.value.pageLength,p(),k())},C=()=>{if(F.value==1)return;let e=t.value.start-t.value.pageLength;e<0&&(e=0),t.value.start=e,p(),k()},T=o(()=>t.value.start+t.value.pageLength<_.value),j=o(()=>t.value.start>0),F=o(()=>Math.ceil(t.value.start/t.value.pageLength)+1),b=o(()=>Math.ceil(_.value/t.value.pageLength)),y=h([]),q=e=>{let r=i=>{switch(i){case"is":return"=";case"is not":return"!=";case"before":return"<";case"after":return">";default:return i}},l=(i,S)=>{switch(S){case"like":return`%${i}%`;case"not like":return`%${i}%`;default:return i}},a=e.filter_type;return e.fieldname=="_assign"&&(a=e.filter_type=="is"?"like":"not like"),[e.fieldname,r(a),l(e.fieldname=="_assign"&&e.value=="@me"?m.userId:e.value,a)]},B=(e,r)=>{if(r){let l={};e.forEach(a=>{let v=a.fieldname,i=a.filter_type,S=a.fieldname=="_assign"&&a.value=="@me"?m.userId:a.value;l[v]=JSON.stringify([i,S])}),$.replace({query:l}),Object.keys(l).length==0&&t.value.saveFiltersLocally&&R()}else{let l=[];for(let a in e)l.push(q(e[a]));R(e,l)}},R=(e=[],r=[])=>{t.value.saveFiltersLocally&&localStorage.setItem(`list_filters_${f.path}`,JSON.stringify(e||[])),u.value.update({filters:r})},x=e=>{let r=`${e} desc`;const l=t.value?.orderBy;l&&l.split(" ")[0]===r.split(" ")[0]&&(r=`${e} ${l.split(" ")[1]==="desc"?"asc":"desc"}`),p({orderBy:r}),L()},J=e=>{c.value==1?c.value=2:c.value==2?u.value.select(e):t.value.handleRowClick(e)},E=e=>{c.value==0&&(c.value=1),e.name in s.value?(delete s.value[e.name],Object.keys(s.value).length==0&&(c.value=0)):s.value[e.name]=e},U=()=>{s.value={}},V=()=>{if(M.value)u.value.unselect();else for(let e=0;e<u.value.list.length;e++)s.value[u.value.list[e].name]=u.value.list[e];d.emit("selection",s.value)},c=h(0),s=h({});X(s.value,e=>{d.emit("selection",e)});const M=o(()=>u.value.loading?!1:u.value.list.length>0?Object.keys(s.value).length==u.value.list.length:!1),w=e=>e.name in s.value,P=e=>{switch(e){case"_assign":return"Assigned to";case"_seen":return!1;default:return e=e.replace(/_/g," "),e.charAt(0).toUpperCase()+e.slice(1)}},G=()=>{let e=f.query,r=[];for(let l in e){let a="like",v="";e[l]=JSON.parse(e[l]),e[l].constructor.name=="Array"?e[l].length==1?v=e[l][0]:(a=e[l][0],v=e[l][1]):v=e[l];let i={label:P(l),fieldname:l,filter_type:a,value:v};r.push(i)}return r},u=h({options:t,list:N,loading:I,totalCount:_,reload:L,update:p,getPage:Q,nextPage:A,previousPage:C,hasNextPage:T,hasPreviousPage:j,currentPageNumber:F,totalPages:b,sudoFilters:y,addFilters:B,toggleOrderBy:x,onClick:J,select:E,unselect:U,selectAll:V,selectionMode:c,selectedItems:s,allItemsSelected:M,itemSelected:w,helperMethods:{convertFieldNameToLabel:P}});return se("manager",u),Y(()=>{Z(()=>{t.value.urlQueryFilters&&Object.keys(f.query).length>0?(y.value=G(),B(y.value,!1)):t.value.saveFiltersLocally&&(y.value=JSON.parse(localStorage.getItem(`list_filters_${f.path}`)||"[]"),B(y.value,t.value.urlQueryFilters)),L()})}),{manager:u}}},ue={class:"h-full"};function ne(n,d,$,f,m,t){return D(),ee("div",ue,[te(n.$slots,"body",{manager:f.manager})])}const oe=H(re,[["render",ne]]);export{oe as L};
