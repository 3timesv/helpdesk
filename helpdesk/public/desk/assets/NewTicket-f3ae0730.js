import{_ as T,s as L,r as m,o as r,c as y,w as u,b as i,t as h,i as d,ca as N,d as c,F as C,e as F,I as V,p as k,cH as E,h as w,m as g,v as D,k as b}from"./index-d9377e3a.js";import{C as R}from"./Card-a4b42a0d.js";import{D as q}from"./Dropdown-e0c50cd3.js";import{E as U}from"./ErrorMessage-e4ff6432.js";import{F as P}from"./FileUploader-997fc331.js";import{T as I,a as j}from"./TextEditor-b1ee2b34.js";import{L as z}from"./ListManager-d2a1afc7.js";import"./LoadingText-f736f9e5.js";import"./use-tracked-pointer-4b3ac621.js";import"./use-resolve-button-type-390b11ae.js";const J={name:"ArticleCard",props:{article:{type:Object}},components:{TextEditor:I,FeatherIcon:L}},G={class:"group rounded-[6px] shadow-md bg-white p-5 w-full flex flex-row justify-between items-center hover:bg-gray-50"},K={class:"text-base text-gray-600"};function Q(e,a,s,l,p,n){const _=m("FeatherIcon"),x=m("router-link");return r(),y(x,{to:`/support/kb/articles/${s.article.name}`},{default:u(()=>[i("div",G,[i("div",K,h(s.article.title),1),d(_,{name:"chevron-right",class:"h-4 w-4 group-hover:visible invisible"})])]),_:1},8,["to"])}const W=T(J,[["render",Q]]),X={name:"ArticleSuggestions",props:{query:{type:String,default:""}},components:{ListManager:z,ArticleCard:W},watch:{query(e){this.$refs.suggestedArticles?.manager&&this.filterOutArticles(e)}},methods:{filterOutArticles:N(function(e=""){this.$refs.suggestedArticles.manager.addFilters([{fieldname:"title",filter_type:"like",value:e},{fieldname:"status",filter_type:"is",value:"Published"}]),this.$refs.suggestedArticles.manager.reload()},500)}},Y={class:"flex flex-col space-y-2 w-full"},Z=i("div",{class:"text-[16px] font-medium"},"Related Articles",-1),$={class:"flex flex-col space-y-2"};function ee(e,a,s,l,p,n){const _=m("ArticleCard"),x=m("ListManager");return r(),c("div",Y,[Z,d(x,{ref:"suggestedArticles",options:{doctype:"Article",fields:["title","content","category","author","creation","modified"],limit:5,order_by:"modified desc",filters:[["Article","status","=","Published"]]}},{body:u(({manager:v})=>[i("div",$,[(r(!0),c(C,null,F(v.list,f=>(r(),c("div",{key:f.name},[d(_,{article:f,class:"w-full"},null,8,["article"])]))),128))])]),_:1},512)])}const te=T(X,[["render",ee]]);const ae={name:"NewTicket",components:{Input:V,TextEditor:I,Card:R,Dropdown:q,ErrorMessage:U,FileUploader:P,FeatherIcon:L,ArticleSuggestions:te,TextEditorFixedMenu:j},props:["templateId"],setup(){const e=D("ticketTemplates"),a=D("ticketController"),s=k({}),l=k({}),p=k(!1),n=k({}),_=k([]);return{ticketTemplates:e,ticketController:a,formData:s,linkedFieldOptions:l,newTicketSubmitLoading:p,validationErrors:n,attachments:_}},computed:{textEditorMenuButtons(){return["Paragraph",["Heading 2","Heading 3","Heading 4","Heading 5","Heading 6"],"Separator","Bold","Italic","Separator","Bullet List","Numbered List","Separator","Align Left","Align Center","Align Right","Separator","Image","Video","Link","Blockquote","Code",["InsertTable","AddColumnBefore","AddColumnAfter","DeleteColumn","AddRowBefore","AddRowAfter","DeleteRow","MergeCells","SplitCell","ToggleHeaderColumn","ToggleHeaderRow","ToggleHeaderCell","DeleteTable"]]},fdSettings(){return this.$resources.fdSettings.doc||null},suggestArticles(){return this.fdSettings?.suggest_articles_in_new_ticket_page||null},template(){const e=this.ticketTemplates.map(a=>a.template_route);if(e.length>0)if(e.includes(this.templateId)){const a=this.ticketTemplates.filter(s=>s.template_route==this.templateId)[0];return this.setLinkedFieldOptions(a),a}else{this.$router.push({name:"DefaultNewTicket"});const a=this.ticketTemplates.filter(s=>s.template_route=="default")[0];return this.setLinkedFieldOptions(a),a}}},resources:{fdSettings(){return{type:"document",doctype:"HD Settings",name:"HD Settings"}}},methods:{focusEditor(e){document.getElementsByClassName(`text-editor-${e.fieldname}`)[0].getElementsByClassName("ql-editor")[0].focus()},submitTicket(){this.setAutoSetFields(),this.validateTicketForm()&&(this.newTicketSubmitLoading=this.ticketController.newTicket(this.formData,this.template.name,this.attachments.map(e=>e.name)))},setAutoSetFields(){this.template.fields&&this.template.fields.forEach(e=>{if(e.auto_set&&e.auto_set_via==="Frontend (JS)"){const s=new Function(e.value_frontend)();this.formData[e.fieldname]=s||"None"}})},validateTicketForm(){let e=[];for(let a in this.template.fields){let s=this.template.fields[a];this.validateField(s,this.formData[s.fieldname]||null),this.validationErrors[s.fieldname]&&e.push(this.validationErrors[s.fieldname])}return!(e.length>0)},validateField(e,a){let s=e.fieldname,l=e.label;this.validationErrors[s]=null,e.reqd&&(a?e.fieldtype=="Text Editor"&&["<p><br></p>","<p></p>"].includes(a.replaceAll(" ",""))&&(this.validationErrors[s]=`${l} is a mandatory field`):this.validationErrors[s]=`${l} is a mandatory field`),this.formData[s]=a},setLinkedFieldOptions(e){for(let a in e.fields){let s=e.fields[a];s.fieldtype=="Link"&&this.setLinkOptions(s)}},getSelectFieldOptions(e){let a=[];return e.options.split(`
`).forEach(s=>{a.push({label:s,handler:()=>{this.formData[e.fieldname]=s}})}),a},async setLinkOptions(e){let a=e.options;if(a){let s=[],l=[];switch(e.filter_using){case"API Response":l=await E(e.api_method);break;case"frappe.get_list()":l=(await E("frappedesk.extends.client.get_list",{doctype:a,filters:e.filters})).map(p=>p.name);break}l.forEach(p=>{s.push({label:p,handler:()=>{this.formData[e.fieldname]=p}})}),this.linkedFieldOptions[a]=s}return null},cancel(){this.$router.push({name:"ProtalTickets"})}}},se={class:"rounded-lg border p-8 shadow-md"},le={class:"font-medium"},ne=["innerHTML"],oe={class:"space-y-4 pb-4"},ie={key:0},re={key:0},de={key:1},ce={key:2},me={class:"mb-2 block text-sm leading-4 text-gray-700"},ue={key:3},pe={class:"mb-2 block text-sm leading-4 text-gray-700"},_e={key:4},fe={class:"mb-2 block text-sm leading-4 text-gray-700"},he={class:"flex max-h-[100px] flex-col overflow-y-scroll rounded"},ge={class:"flex flex-wrap gap-2 pb-4"},xe=["title"],ke={class:"flex flex-row items-center space-x-1"},be={class:"ml-2 max-w-[100px] truncate text-[12px] font-normal text-gray-700"},ye=["onClick"],ve={class:"mb-1 flex space-x-2"},we=i("div",{class:"grow"},null,-1),Ce={key:0,class:"w-full border-l px-5"};function Fe(e,a,s,l,p,n){const _=m("Input"),x=m("TextEditorFixedMenu"),v=m("TextEditor"),f=m("Button"),A=m("Dropdown"),B=m("ErrorMessage"),S=m("FeatherIcon"),O=m("FileUploader"),M=m("ArticleSuggestions");return n.template?(r(),c("div",{key:0,class:w(["mx-auto mt-5 flex flex-row pt-4",{"max-w-2xl":!n.suggestArticles,"max-w-5xl space-x-5":n.suggestArticles}])},[i("div",{class:w(["shrink-0",{"w-[55%]":n.suggestArticles,"w-full":!n.suggestArticles}])},[i("div",se,[i("div",le,h(`New Ticket ${n.template.template_name!="Default"?`(${n.template.template_name})`:""}`),1),i("div",{class:"pb-2 text-[13px] text-gray-700",innerHTML:n.template.about},null,8,ne),i("div",oe,[(r(!0),c(C,null,F(n.template.fields,t=>(r(),c("div",{key:t},[t.auto_set?g("",!0):(r(),c("div",ie,[t.fieldtype=="Data"?(r(),c("div",re,[d(_,{modelValue:l.formData[t.fieldname],"onUpdate:modelValue":o=>l.formData[t.fieldname]=o,label:t.label,type:"text",onInput:o=>{n.validateField(t,o)}},null,8,["modelValue","onUpdate:modelValue","label","onInput"])])):t.fieldtype=="Long Text"?(r(),c("div",de,[d(_,{modelValue:l.formData[t.fieldname],"onUpdate:modelValue":o=>l.formData[t.fieldname]=o,label:t.label,type:"textarea",onChange:o=>{n.validateField(t,o)}},null,8,["modelValue","onUpdate:modelValue","label","onChange"])])):t.fieldtype=="Text Editor"?(r(),c("div",ce,[i("div",me,h(t.label),1),d(v,{content:e.content,"editor-class":"px-[12px] pt-[5px] rounded-t-[8px] text-[13px] min-h-[100px] max-h-[200px] max-w-full overflow-y-scroll bg-gray-100",placeholder:"Type your text here...",class:"rounded-[8px] border border-gray-300",onChange:o=>{n.validateField(t,o)}},{bottom:u(()=>[d(x,{class:"w-full border-t bg-transparent px-1.5",buttons:n.textEditorMenuButtons},null,8,["buttons"])]),_:2},1032,["content","onChange"])])):t.fieldtype=="Link"?(r(),c("div",ue,[i("div",pe,h(t.label),1),l.linkedFieldOptions[t.options]?(r(),y(A,{key:0,options:l.linkedFieldOptions[t.options],placement:"left","dropdown-width-full":!0,onChange:o=>{n.validateField(t,o)}},{default:u(({toggleDropdown:o})=>[i("div",null,[d(f,{onClick:o},{default:u(()=>[b(h(l.formData[t.fieldname]||"Select"),1)]),_:2},1032,["onClick"])])]),_:2},1032,["options","onChange"])):g("",!0)])):t.fieldtype=="Select"?(r(),c("div",_e,[i("div",fe,h(t.label),1),n.getSelectFieldOptions(t)?(r(),y(A,{key:0,options:n.getSelectFieldOptions(t),placement:"left","dropdown-width-full":!0,onChange:o=>{n.validateField(t,o)}},{default:u(({toggleDropdown:o})=>[i("div",null,[d(f,{onClick:o},{default:u(()=>[b(h(l.formData[t.fieldname]||"Select"),1)]),_:2},1032,["onClick"])])]),_:2},1032,["options","onChange"])):g("",!0)])):g("",!0),l.validationErrors[t.fieldname]?(r(),y(B,{key:5,class:"mt-1",message:l.validationErrors[t.fieldname]},null,8,["message"])):g("",!0)]))]))),128))]),i("div",he,[i("ul",ge,[(r(!0),c(C,null,F(l.attachments,t=>(r(),c("li",{key:t,class:"flex items-center space-x-2 rounded border border-gray-400 bg-gray-100 p-1 shadow",title:t.name},[i("div",ke,[d(S,{name:"file-text",class:"h-[15px] stroke-gray-600"}),i("span",be,h(t.file_name),1)]),i("button",{class:"grid h-4 w-4 place-items-center rounded text-gray-700 hover:bg-gray-300",onClick:()=>{l.attachments=l.attachments.filter(o=>o.name!=t.name)}},[d(S,{class:"w-3",name:"x"})],8,ye)],8,xe))),128))])]),i("div",ve,[d(O,{onSuccess:a[0]||(a[0]=t=>l.attachments.push(t))},{default:u(({progress:t,uploading:o,openFileSelector:H})=>[d(f,{disabled:o,onClick:H},{default:u(()=>[b("Add Attachment")]),_:2},1032,["disabled","onClick"])]),_:1}),we,d(f,{class:w(l.newTicketSubmitLoading?"cursor-not-allowed disabled":""),onClick:a[1]||(a[1]=t=>n.cancel())},{default:u(()=>[b("Cancel")]),_:1},8,["class"]),d(f,{loading:l.newTicketSubmitLoading,appearance:"primary",onClick:a[2]||(a[2]=t=>n.submitTicket())},{default:u(()=>[b("Submit")]),_:1},8,["loading"])])])],2),n.suggestArticles?(r(),c("div",Ce,[d(M,{query:l.formData.subject||""},null,8,["query"])])):g("",!0)],2)):g("",!0)}const He=T(ae,[["render",Fe]]);export{He as default};
